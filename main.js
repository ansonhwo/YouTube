var videos = [
{
  title: "A Message from President-Elect Donald J. Trump",
  channel: "Transition 2017",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "The President-elect shares an update on the Presidential Transition," +
    " an outline of some of his policy plans for the first 100 days, and his day one executive actions.",
  views: "1,341,158",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/7xX_KaStFT8/hqdefault.jpg?custom=true&w=196&h=110&stc=true&jpg444=true&jpgq=90&sp=68&sigh=sSuKCtqF5viHrZPjm2RfTsPvqNs",
  embed: 'https://www.youtube.com/embed/7xX_KaStFT8?autoplay=1'
},
{
  title: "Cars 3 Official US Teaser Trailer",
  channel: "Disney-Pixar",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "From this moment, everything will change.\n\nDisney/Pixar's Cars 3 opens in US theatres" +
    " in 3D June 16, 2017.\n\nBlindsided by a new generation of blazing-fast races, the legendary Lightning McQueen (voice of Owen" +
    " Wilson) is suddenly pushed out of the sport he loves. To get back in the game, he will need the help of" +
    " an eager young race technician, Cruz Ramirez, with her own plan to win, plus inspiration from the late Fabulous" +
    " Hudson Hornet and a few unexpected turns.",
  views: "3,258,307",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/E4K7JgPJ8-s/hqdefault.jpg?custom=true&w=196&h=110&stc=true&jpg444=true&jpgq=90&sp=68&sigh=DEWWRQJ38bHkSaBCT19c7Xeimnw",
  embed: 'https://www.youtube.com/embed/E4K7JgPJ8-s?autoplay=1'
},
{
  title: "Flip Edition | Dude Perfect",
  channel: "Dude Perfect",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "It's time to flip some stuff!\nThanks to Fantasitc Gymnastics by Hasbro Gaming for sponsoring" +
    " this video! Go to http://bit.ly/FantasticGymnasticsDP to get Fantastic Gymnastics for yourself!",
  views: "4,460,870",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/8YydogFXCPM/hqdefault.jpg?custom=true&w=196&h=110&stc=true&jpg444=true&jpgq=90&sp=68&sigh=MzABtab1-7LFj6m97B5xOS-lCgk",
  embed: 'https://www.youtube.com/embed/8YydogFXCPM?autoplay=1'
},
{
  title: "Billy on the Street: DEATH ROGEN! With Seth Rogen",
  channel: "billyonthestreettv",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "New from Billy on the Street! Watch Billy hit the street with SETH ROGEN in disguise, tell" +
    " people that Seth has died and get their reactions! We call this DEATH ROGEN. Watch full episodes of Billy on the Street Tuesdays at 10:30/9:30c on @TruTV!",
  views: "364,533",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/A2R2iBc8udc/hqdefault.jpg?custom=true&w=168&h=94&stc=true&jpg444=true&jpgq=90&sp=68&sigh=j7ivnsDvrCl-ucJWKLoscivhtrs",
  embed: 'https://www.youtube.com/embed/diN92St7FA8?autoplay=1'
},
{
  title: "Bullets vs Propeller in Slow Motion - The Slow Mo Guys",
  channel: "The Slow Mo Guys",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "Gary and Dan venture out to the desert to film some bullets. Make sure you watch in HD for maximum bullet" +
    " shockwave action!\nCheers to EA for sponsoring this video. Check out the game at http://www.battlefield.com\n" +
    "Follow Gav on Twitter - https://twitter.com/GavinFree\nFollow Dan on Twitter - https://twitter.com/DanielGruchy",
  views: "1,466,332",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/ysB-SH19WRQ/hqdefault.jpg?custom=true&w=196&h=110&stc=true&jpg444=true&jpgq=90&sp=68&sigh=9OEQLS6JSWBMQ8sCrd0yZt58lJ8",
  embed: 'https://www.youtube.com/embed/ysB-SH19WRQ?autoplay=1'
},
{
  title: 'The Voice 2016 Billy Gilman - Top 11: "All I Ask"',
  channel: "The Voice",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "Billy Gilman showcases his vocal talent with a powerful rendition of 'All I Ask' by Adele.\n\n" +
    "NBC's The Voice follows the strongest vocalists from across the country and invites them to compete in" +
    " this season's blockbuster vocal competition.",
  views: "213,615",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/RswuJVHVw_0/hqdefault.jpg?custom=true&w=196&h=110&stc=true&jpg444=true&jpgq=90&sp=68&sigh=6lmdPt82bEpmKOw202Zi67Iwk7U",
  embed: 'https://www.youtube.com/embed/RswuJVHVw_0?autoplay=1'
},
{
  title: "The iPhone 8 Will Be Incredible!",
  channel: "EverythingApplePro",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "iPhone 8 & 8 Plus Rumors & Leaks Have Begun! New Features To Expect & Rumor Roundup With Sources!",
  views: "693,167",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/MZqyfeUi7As/hqdefault.jpg?custom=true&w=196&h=110&stc=true&jpg444=true&jpgq=90&sp=68&sigh=HDgDRvuiwhCcMHXVT0Gm9eukqU8",
  embed: 'https://www.youtube.com/embed/MZqyfeUi7As?autoplay=1'
},
{
  title: "10 Disney Crossover Easter Eggs That You've Never Seen",
  channel: "Screen Rant",
  channelicon: "https://yt3.ggpht.com/-CmoaPOAkgk8/AAAAAAAAAAI/AAAAAAAAAAA/RCGcK9m4sHo/s48-c-k-no-mo-rj-c0xffffff/photo.jpg",
  description: "Animated movies are a right of passage for most children, and nobody does them better than Disney. Every child remembers watching Snow White and" +
    " The Little Mermaid for the first time, and most of us are still heading to theatres whenever a new Pixar film comes out. But we don't always catch the Easter" +
    " eggs left there by mischievious animators, or the cameos that some Disney characters make in movies that aren't their own.",
  views: "260,853",
  comments: [],
  thumbnail: "https://i.ytimg.com/vi/KBTwUOsO4d0/hqdefault.jpg?custom=true&w=196&h=110&stc=true&jpg444=true&jpgq=90&sp=68&sigh=Ue_RmuQ0uggRmpbxvxQAiC-w060",
  embed: 'https://www.youtube.com/embed/KBTwUOsO4d0?autoplay=1'
}];
var users = [{
  name: "User1",
  icon: "http://simpleicon.com/wp-content/uploads/user1.png",
  subscribed: []
},
{
  name: "User2",
  icon: "https://cdn0.iconfinder.com/data/icons/PRACTIKA/256/user.png",
  subscribed: []
},
{
  name: "User3",
  icon: "http://downloadicons.net/sites/default/files/women-business-user-icon-44928.png",
  subscribed: []
},
{
  name: "User4",
  icon: "https://cdn0.iconfinder.com/data/icons/PRACTIKA/256/user.png",
  subscribed: []
}];
var currentUser = 1;
var CE = createElement;


// Deletes all of the children associated with the provided element ID.
function deleteChild(element) {
  while (element.hasChildNodes()) {
    element.removeChild(element.lastChild);
  }
}


// Create elements with the given attributes & child nodes
function createElement(tagName, attributes, children) {
  var element = document.createElement(tagName);
  for (var key in attributes) {
    element.setAttribute(key, attributes[key]);
  }
  for (var index = 0; index < children.length; index++) {
    var child = children[index];
    if (child instanceof Element) {
      element.appendChild(child);
    }
    else {
      element.appendChild(document.createTextNode(child));
    }
  }
  return element;
}


// Return an array of matched video objects based on user query.
function findMatch(query) {
  var videoList = [];
  var videoScores = [];
  var searchWords = query.split(' ');
  var channel, title, description, subscribed, score = 0;

  for (var index = 0; index < searchWords.length; index++) {
    var search = searchWords[index];

    if (search) {
      search = search.toLowerCase().replace(/[^A-Za-z0-9\s]/g,'');
      console.log('[[[ searching for: "' + search + '" ]]]');

      for (var video = 0; video < videos.length; video++) {
        subscribed = false;
        channel = videos[video].channel.toLowerCase().replace(/[^A-Za-z0-9\s]/g,'').includes(search);
        title = videos[video].title.toLowerCase().replace(/[^A-Za-z0-9\s]/g,'').includes(search);
        description = videos[video].description.toLowerCase().replace(/[^A-Za-z0-9\s]/g,'').includes(search);
        if (channel || title || description) {
          if (getScore(videoScores, video) < 0) {
            videoScores.push([video, 0]);
            score = 0;
          }
          else {
            score = getScore(videoScores, video);
          }
          for (var sub = 0; sub < users[currentUser].subscribed.length; sub++) {
            if (users[currentUser].subscribed[sub] === videos[video].channel) subscribed = true;
          }
          console.log('Title: ' + videos[video].title + '\n\tChannel: ' + videos[video].channel + '\n\tDescription: ' + videos[video].description + '\n\tSubscribed? ' + subscribed);
          if (subscribed) {
            if (channel) score += 20;
            if (title) score += 10;
            if (description) score += 0.5;
          }
          else {
            if (channel) score += 1;
            if (title) score += 0.5;
            if (description) score += 0.1;
          }
          setScore(videoScores, video, score);
          console.log('\tscore: ' + score + '\nvideo scores: ' + videoScores);
        }
      }
    }
    console.log('\n====================\n====================\n====================');
  }
  console.log('unsorted scores: ' + videoScores);
  videoScores.sort(function (video1, video2) {
    if (video1[1] < video2[1]) return 1;
    else return 0;
  });
  console.log('sorted scores: ' + videoScores);

  for (var index = 0; index < videoScores.length; index++) {
    videoList.push(videos[videoScores[index][0]]);
  }
  return videoList;
}


// Finds if a score already exists for a matched video
function getScore(list, video) {
  var score = -1;
  for (var index = 0; index < list.length; index++) {
    if (list[index][0] === video) {
      score = list[index][1];
      break;
    }
  }
  return score;
}


// Updates the score for the specified video
function setScore(list, video, score) {
  for (var index = 0; index < list.length; index++) {
    if (list[index][0] === video) {
      list[index][1] = score;
      break;
    }
  }
}


// Builds video list with videos that match the user's search query
function buildVideoList(elements) {
  var $videoList = document.getElementById('videos');
  var $videoBlock = CE('div', {'id': 'videoblock'}, []);

  $videoList.appendChild($videoBlock);

  for (var index = 0; index < elements.length; index++) {
    var $videoDetails =
      CE('div', {'id': 'videodetails'}, [
        CE('a', {'href': '#'}, [
          CE('img', {'class': 'videoimg', 'src': elements[index].thumbnail, 'data-embed': elements[index].embed}, [])
        ]),
        CE('a', {'href': '#'}, [
          CE('h4', {'class': 'videotitle', 'data-embed': elements[index].embed}, [elements[index].title])
        ]),
        CE('p', {'class': 'videochannel'}, [elements[index].channel]),
        CE('p', {'class': 'videoviews'}, [elements[index].views + ' views']),
        CE('p', {'class': 'videodesc'}, [elements[index].description])
      ]);
    $videoBlock.appendChild($videoDetails);
  }
}


// Builds the video viewing area containing video related details
function buildViewingArea(embed) {
  buildVideoArea(embed);

  buildVideoDetails(embed);

  addCommentsArea();

  var index = findVideo(embed);
  userCommentsArea(index);
}


// Populate the Video Player area
function buildVideoArea(embed) {
  var $videos = document.getElementById('videos');
  var $viewingArea = CE('div', {'id': 'viewingarea'}, []);
  $videos.appendChild($viewingArea);

  var $embed =
    CE('div', {'id': 'embed'}, [
      CE('iframe', {'id': 'uservideo', 'height': '480px', 'width': '854px', 'src': embed, 'frameborder': 0, 'allowfullscreen': ''}, [])
    ]);
  $viewingArea.appendChild($embed);
}


// Populate the Video Details section
function buildVideoDetails(embed) {
  var $videos = document.getElementById('videos');
  var index = findVideo(embed);
  var subscribed = users[currentUser].subscribed.includes(videos[index].channel);
  var $channelbox =
      CE('div', {'id': 'channelbox'}, [
        CE('img', {'class': 'videoicon', 'src': videos[index].channelicon}, []),
        CE('div', {'class': 'channelwrap'}, [
          CE('p', {'class': 'channel'}, [videos[index].channel]),
          CE('button', {'id': 'subscribe', 'class': subscribed ? 'yes' : 'no'}, [subscribed ? '✓ Subscribed' : 'Subscribe'])
        ])
      ]);
  var $titlebox =
    CE('div', {'id': 'titlebox'}, [
      CE('h2', {'class': 'title'}, [videos[index].title])
    ]);
  var $videoinfo =
    CE('div', {'id': 'videoinfo'}, [
      $titlebox, $channelbox,
      CE('p', {'class': 'views'}, [videos[index].views + ' views']),
      CE('p', {'class': 'desc'}, [videos[index].description])
  ]);

  $videos.appendChild($videoinfo);
}


// Populate the Add Comments section
function addCommentsArea() {
  var $videos = document.getElementById('videos');
  var $author =
    CE('span', {'class': 'author'}, [
      CE('img', {'class': 'icon', 'src': users[currentUser].icon}, [])
    ]);
  var $commentWrap =
    CE('div', {'class': 'wrap'}, [
      CE('form', {'action': ''}, [
        CE('textarea', {'class': 'input', 'type': 'text', 'placeholder': 'Add a public comment...', 'name': 'comment'}, [])
      ]),
      CE('div', {'class': 'buttonwrap'}, [
        CE('button', {'class': 'submitcomment'}, ['Comment']),
        CE('button', {'class': 'cancelcomment'}, ['Cancel'])
      ])
    ]);
  var $addComments = CE('div', {'id': 'addcomments'}, [
    CE('h4', {'class': 'header'}, []),
    $author,
    $commentWrap
  ]);

  $videos.appendChild($addComments);
}


// Populate the User Comments section
function userCommentsArea(index) {
  var $videos = document.getElementById('videos');
  var $commentHeader = document.querySelector('#addcomments .header');
  var numComments = videos[index].comments.length;

  $commentHeader.textContent = 'COMMENTS • ' + numComments;

  if (numComments > 0) {
    var $exists = document.getElementById('usercomments');

    if ($exists) {
      deleteChild($exists);
      populate(index, $exists, numComments);
    }
    else {
      var $userComments = CE('div', {'id': 'usercomments'}, []);
      $videos.appendChild($userComments);
      populate(index, $userComments, numComments);
    }
  }
}


// Helper function that adds comments to user comment area
function populate(video, $element, numComments) {
  for (var index = 0; index < numComments; index++) {
    var $userComment = CE('div', {'class': 'block'}, [
      CE('span', {'class': 'author'}, [
        CE('img', {'class': 'icon', 'src': videos[video].comments[index].icon}, [])
      ]),
      CE('div', {'class': 'wrap'}, [
        CE('p', {'class': 'user'}, [videos[video].comments[index].user]),
        CE('p', {'class': 'comment'}, [videos[video].comments[index].comment])
      ])
    ]);

    $element.appendChild($userComment);
  }
}


// Adds a new comment to the current video
function addComment(video, user) {
  var $input = document.querySelector('#addcomments .input');
  var input = $input.value.trim();
  if (input) {
    var comment = new Comment(users[user].name, users[user].icon, 40, input);
    videos[video].comments.unshift(comment);
    $input.value = '';
    userCommentsArea(video);
  }
}


// Comment object constructor
function Comment(user, icon, age, comment) {
  this.user = user;
  this.icon = icon;
  this.age = age;
  this.comment = comment;
}


// Helper function that returns index of target video in video database
function findVideo(embed) {
  for (var index = 0; index < videos.length; index++) {
    if (videos[index].embed === embed) {
      return index;
    }
  }
}


document.addEventListener('submit', function(event) {

  event.preventDefault();

  var query = document.getElementById('searchbar').value;

  if (query.trim()) {
    query = query.trim();
    var videoList = findMatch(query);
    var $videoBlock = CE('div', {'class': 'videoblock'}, []);
    var $videos = document.getElementById('videos');

    $videos.appendChild($videoBlock);

    deleteChild($videos);

    if (videoList.length > 0) {
      buildVideoList(videoList);
    }
    else {
      var $invalidSearch = CE('h2', {'id': 'invalidsearch'}, ['No results found for: ' + query + '.']);

      $videos.appendChild($invalidSearch);
    }
  }
  else return;

});


document.addEventListener('click', function(event) {
  var $target = event.target;
  var embedURL;
  if ($target.className === 'videoimg' || $target.className === 'videotitle') {
    event.preventDefault();

    var $videos = document.getElementById('videos');
    embedURL = $target.getAttribute('data-embed');

    deleteChild($videos);

    buildViewingArea(embedURL);
  }
  if ($target.className === 'submitcomment') {
    embedURL = document.getElementById('uservideo').getAttribute('src');
    addComment(findVideo(embedURL), currentUser);
  }
  if ($target.className === 'cancelcomment') {
    document.querySelector('#addcomments .input').value = '';
  }
  if ($target.id === 'subscribe') {
    var channel = document.querySelector('#videoinfo .channelwrap .channel').textContent;
    if($target.className === 'yes') {
      $target.setAttribute('class', 'no');
      $target.textContent = 'Subscribe';
      users[currentUser].subscribed.splice(users[currentUser].subscribed.indexOf(channel), 1);
    }
    else {
      $target.setAttribute('class', 'yes');
      $target.textContent = '✓ Subscribed';
      users[currentUser].subscribed.push(channel);
    }
  }
});
